<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resiliência — Orquestraio Docs</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<link rel="stylesheet" href="style.css">
</head>
<body>

<nav class="topnav" id="topnav">
  <div class="topnav-inner">
    <a href="index.html" class="topnav-logo">
      <div class="topnav-logo-mark">
        <svg viewBox="0 0 24 24" fill="none" stroke="#a78bfa" stroke-width="2"><path d="M9 3v14M9 3H5M9 3h4M15 3v14M15 3h4"/></svg>
      </div>
      <span class="topnav-logo-text">Orquestraio</span>
      <span class="topnav-version">v0.4</span>
    </a>
    <div class="topnav-right">
      <a href="https://github.com/vitinh0z/orquestraio" class="topnav-icon-btn" target="_blank" rel="noopener" title="GitHub">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg>
      </a>
      <button class="topnav-icon-btn" onclick="toggleTheme()" title="Alternar tema">
        <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
      </button>
    </div>
  </div>
</nav>

<aside class="sidebar">
  <div class="sidebar-section">
    <div class="sidebar-section-label">Inicio</div>
    <a href="index.html" class="sidebar-item">Introducao</a>
    <a href="quickstart.html" class="sidebar-item">Primeiros Passos</a>
    <a href="autenticacao.html" class="sidebar-item">Autenticacao</a>
    <a href="glossario.html" class="sidebar-item">Glossario</a>
    <a href="changelog.html" class="sidebar-item">Changelog</a>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-section-label">API</div>
    <a href="processar-pagamento.html" class="sidebar-item">Processar Pagamento</a>
    <a href="metodos-pagamento.html" class="sidebar-item">Metodos de Pagamento</a>
    <a href="smartrouter.html" class="sidebar-item">SmartRouter</a>
    <a href="webhooks.html" class="sidebar-item">Webhooks</a>
    <a href="erros-status.html" class="sidebar-item">Erros & Status</a>
    <a href="rate-limiting.html" class="sidebar-item">Rate Limiting</a>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-section-label">Funcionalidades</div>
    <a href="resiliencia.html" class="sidebar-item active">Resiliencia</a>
    <a href="seguranca.html" class="sidebar-item">Seguranca</a>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-section-label">Guias</div>
    <a href="sandbox.html" class="sidebar-item">Sandbox & MOCK</a>
  </div>
</aside>

<div class="shell">
  <main class="main">

    <div class="section-label">Funcionalidades</div>
    <h1 class="section-title">Resiliência & Consistência</h1>
    <div class="reading-time-badge">
      <svg viewBox="0 0 24 24" width="11" height="11" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
      4 min de leitura
    </div>
    <p class="section-desc">Idempotência e Circuit Breaker fazem parte do core do Orquestraio — não são opcionais. Esta página documenta ambos os mecanismos.</p>

    <h2>Idempotência</h2>
    <p>O campo <code>idempotencyKey</code> garante que a mesma transação nunca seja processada duas vezes, mesmo com falhas de rede e múltiplas tentativas.</p>

    <div class="callout callout-code">
      <span class="callout-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--purple-light)" stroke-width="2"><line x1="12" y1="17" x2="12" y2="22"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"/></svg>
      </span>
      <div class="callout-body">Typo corrigido na v0.4.0: <strong>idempotecyKey → idempotencyKey</strong>. Atualize suas requisições se estiver usando a v0.3.x.</div>
    </div>

    <h3>Como Funciona</h3>
    <p>Quando uma requisição chega com um <code>idempotencyKey</code>:</p>
    <ol>
      <li>O Orquestraio verifica no Redis se essa chave já foi processada</li>
      <li>Se não existe, processa normalmente e armazena o resultado com TTL de 24h</li>
      <li>Se já existe, retorna o resultado cacheado sem chamar o gateway novamente</li>
    </ol>

    <div class="mermaid-wrap">
      <div class="mermaid">
sequenceDiagram
  participant C as Cliente
  participant O as Orquestraio
  participant R as Redis
  participant G as Gateway
  C->>O: POST /v1/payments (idempotencyKey: "order-abc")
  O->>R: Verificar chave
  R-->>O: Não existe - processar
  O->>G: Criar pagamento
  G-->>O: APPROVED
  O->>R: Salvar resultado (TTL 24h)
  O-->>C: 201 APPROVED
  C->>O: POST /v1/payments (idempotencyKey: "order-abc")
  O->>R: Verificar chave
  R-->>O: Existe - retornar cache
  O-->>C: 201 APPROVED (cached)
      </div>
    </div>

    <div class="callout callout-success">
      <span class="callout-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--emerald)" stroke-width="2.5"><path d="M20 6 9 17l-5-5"/></svg>
      </span>
      <div class="callout-body"><strong>Boas práticas:</strong> Use UUID v4 gerado no backend, vinculado ao ID do pedido no seu sistema. Nunca reutilize a mesma chave para transações distintas.</div>
    </div>

    <div class="divider"></div>

    <h2>Circuit Breaker</h2>
    <p>Cada gateway tem circuit breaker independente via <strong>Resilience4j</strong>. Quando a taxa de falha ultrapassa o threshold, o gateway é isolado temporariamente.</p>

    <h3>Configuração por Gateway</h3>
    <table class="doc-table">
      <thead><tr><th>Gateway</th><th>Janela</th><th>Threshold</th><th>Tempo aberto</th><th>Half-open</th></tr></thead>
      <tbody>
      <tr><td><code>STRIPE</code></td><td>10 req</td><td>50%</td><td>20s</td><td>3 calls</td></tr>
      <tr><td><code>MERCADO_PAGO</code></td><td>10 req</td><td>50%</td><td>15s</td><td>3 calls</td></tr>
      <tr><td><code>PAYPAL</code></td><td>10 req</td><td>50%</td><td>20s</td><td>3 calls</td></tr>
      </tbody>
    </table>

    <h3>Estados do Circuit Breaker</h3>
    <div class="mermaid-wrap">
      <div class="mermaid">
stateDiagram-v2
  [*] --> CLOSED
  CLOSED --> OPEN : falhas > 50% em 10 req
  OPEN --> HALF_OPEN : após timeout (20s)
  HALF_OPEN --> CLOSED : 3 chamadas OK
  HALF_OPEN --> OPEN : qualquer falha
      </div>
    </div>

    <div style="margin-top:1.5rem;padding:1rem;background:var(--bg-2);border:1px solid var(--border);">
      <p style="margin:0;"><strong style="color:var(--text);">CLOSED:</strong> Gateway funcionando normalmente. Todas as requisições são enviadas.</p>
      <p style="margin:0.5rem 0 0;"><strong style="color:var(--text);">OPEN:</strong> Gateway em falha. Requisições retornam erro imediatamente sem chamar o gateway.</p>
      <p style="margin:0.5rem 0 0;"><strong style="color:var(--text);">HALF_OPEN:</strong> Gateway em teste. Permite 3 chamadas para verificar se voltou ao normal.</p>
    </div>

    <div class="callout callout-info" style="margin-top:1.5rem;">
      <span class="callout-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--purple-light)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
      </span>
      <div class="callout-body"><strong>Fallback automático:</strong> Se o gateway principal estiver OPEN, o SmartRouter tenta automaticamente um gateway alternativo compatível antes de retornar erro ao cliente.</div>
    </div>

    <h3>Exemplo de Cenário Real</h3>
    <ol>
      <li>10 requisições enviadas para o Stripe</li>
      <li>6 delas falham (timeout, 500, etc.) — <strong>60% de falha</strong></li>
      <li>Circuit Breaker muda para OPEN</li>
      <li>Próximas requisições retornam erro imediatamente por 20 segundos</li>
      <li>Após 20s, muda para HALF_OPEN e permite 3 tentativas</li>
      <li>Se as 3 tentativas forem bem-sucedidas, volta para CLOSED</li>
    </ol>

    <p style="margin-top:2rem;color:var(--text-3);font-size:0.82rem;">Os estados do Circuit Breaker são logados em <code>execution_history</code> e podem ser monitorados via métricas (Prometheus/Grafana em v0.6).</p>

  </main>
</div>

<script>
function toggleTheme(){
  const html=document.documentElement;
  const isLight=html.getAttribute('data-theme')==='light';
  const newTheme=isLight?'dark':'light';
  html.setAttribute('data-theme',newTheme);
  localStorage.setItem('theme',newTheme);
  document.getElementById('themeIcon').innerHTML=isLight
    ?'<circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>'
    :'<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
}
function applyTheme(){
  const saved=localStorage.getItem('theme');
  if(saved==='light'){
    document.documentElement.setAttribute('data-theme','light');
    document.getElementById('themeIcon').innerHTML='<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
  }
}
applyTheme();
function initMermaid(){
  const theme=document.documentElement.getAttribute('data-theme')==='light'?'default':'dark';
  if(typeof mermaid==='undefined')return;
  mermaid.initialize({startOnLoad:false,theme,securityLevel:'loose'});
  document.querySelectorAll('.mermaid').forEach(el=>{
    if(!el.hasAttribute('data-processed')){
      mermaid.render('mermaid-'+Math.random().toString(36).slice(2),el.textContent).then(result=>{
        el.innerHTML=result.svg;
      });
    }
  });
}
window.addEventListener('load',initMermaid);
</script>

</body>
</html>
