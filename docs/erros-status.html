<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Erros & Status — Orquestraio Docs</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body>

<nav class="topnav" id="topnav">
  <div class="topnav-inner">
    <a href="index.html" class="topnav-logo">
      <div class="topnav-logo-mark">
        <svg viewBox="0 0 24 24" fill="none" stroke="#a78bfa" stroke-width="2"><path d="M9 3v14M9 3H5M9 3h4M15 3v14M15 3h4"/></svg>
      </div>
      <span class="topnav-logo-text">Orquestraio</span>
      <span class="topnav-version">v0.4</span>
    </a>
    <div class="topnav-right">
      <a href="https://github.com/vitinh0z/orquestraio" class="topnav-icon-btn" target="_blank" rel="noopener" title="GitHub">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg>
      </a>
      <button class="topnav-icon-btn" onclick="toggleTheme()" title="Alternar tema">
        <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
      </button>
    </div>
  </div>
</nav>

<aside class="sidebar">
  <div class="sidebar-section">
    <div class="sidebar-section-label">Inicio</div>
    <a href="index.html" class="sidebar-item">Introducao</a>
    <a href="quickstart.html" class="sidebar-item">Primeiros Passos</a>
    <a href="autenticacao.html" class="sidebar-item">Autenticacao</a>
    <a href="glossario.html" class="sidebar-item">Glossario</a>
    <a href="changelog.html" class="sidebar-item">Changelog</a>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-section-label">API</div>
    <a href="processar-pagamento.html" class="sidebar-item">Processar Pagamento</a>
    <a href="metodos-pagamento.html" class="sidebar-item">Metodos de Pagamento</a>
    <a href="smartrouter.html" class="sidebar-item">SmartRouter</a>
    <a href="webhooks.html" class="sidebar-item">Webhooks</a>
    <a href="erros-status.html" class="sidebar-item active">Erros &amp; Status</a>
    <a href="rate-limiting.html" class="sidebar-item">Rate Limiting</a>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-section-label">Funcionalidades</div>
    <a href="resiliencia.html" class="sidebar-item">Resiliencia</a>
    <a href="seguranca.html" class="sidebar-item">Seguranca</a>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-section-label">Guias</div>
    <a href="sandbox.html" class="sidebar-item">Sandbox &amp; MOCK</a>
  </div>
</aside>

<div class="shell">
  <main class="main">

    <div class="section-label">API</div>
    <h1 class="section-title">Erros &amp; Status HTTP</h1>
    <div class="reading-time-badge">
      <svg viewBox="0 0 24 24" width="11" height="11" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
      4 min de leitura
    </div>
    <p class="section-desc">A API retorna erros em formato padronizado via <code>GlobalExceptionHandler</code>. Todos os erros incluem os campos <code>timestamp</code> (Unix ms), <code>status</code>, <code>error</code>, <code>message</code> e <code>path</code> — definidos pela classe <code>StandardError</code>.</p>

    <div class="callout callout-info" style="margin-bottom:1.5rem;">
      <strong>Estrutura StandardError</strong><br>
      Todos os erros retornados pela API seguem este contrato exato. O campo <code>timestamp</code> é um <code>Long</code> em milissegundos Unix, útil para correlacionar com logs internos via <code>System.currentTimeMillis()</code>.
    </div>

    <div class="status-table">
      <div class="status-group-header sg-2xx">2xx — Sucesso</div>
      <div class="status-row">
        <span class="status-code s-2xx">201</span>
        <span class="status-name">Created</span>
        <span class="status-desc">Pagamento criado com sucesso. O <code>PaymentController</code> retorna <code>ResponseEntity.status(HttpStatus.CREATED).body(response)</code>.</span>
      </div>
      <div class="status-row">
        <span class="status-code s-2xx">200</span>
        <span class="status-name">OK</span>
        <span class="status-desc">Retornado quando o <code>idempotencyKey</code> já existe com status <code>APPROVED</code> ou <code>FAILED</code> — o payload original é devolvido sem reprocessamento.</span>
      </div>

      <div class="status-group-header sg-4xx" style="border-top:1px solid var(--border);">4xx — Erro do cliente</div>
      <div class="status-row">
        <span class="status-code s-4xx">400</span>
        <span class="status-name">Bad Request</span>
        <span class="status-desc">Lançado pelo <code>GlobalExceptionHandler</code> ao capturar <code>MethodArgumentNotValidException</code>. Ocorre quando campos <code>@NotNull</code>, <code>@NotBlank</code> ou <code>@DecimalMin</code> falham na validação do <code>PaymentRequestDTO</code>.</span>
      </div>
      <div class="status-row">
        <span class="status-code s-4xx">401</span>
        <span class="status-name">Unauthorized</span>
        <span class="status-desc">O header <code>x-api-key</code> está ausente ou contém uma chave que não existe no banco (hash SHA-256 não encontrado). Retornado pelo <code>ApiKeyAuthFilter</code> antes de qualquer processamento de negócio. Verifique se a chave está correta e incluída em todas as requisições.</span>
      </div>
      <div class="status-row">
        <span class="status-code s-4xx">403</span>
        <span class="status-name">Forbidden</span>
        <span class="status-desc">A <code>x-api-key</code> é válida, mas o tenant associado está com status <code>INACTIVE</code> no banco. O <code>GlobalExceptionHandler</code> mapeia <code>TenantInactiveException</code> → <code>403</code>. Diferente do <code>401</code>: a chave existe, mas o acesso foi bloqueado administrativamente.</span>
      </div>
      <div class="status-row">
        <span class="status-code s-4xx">404</span>
        <span class="status-name">Not Found</span>
        <span class="status-desc">Recurso solicitado não encontrado. O <code>GlobalExceptionHandler</code> mapeia <code>ResourceNotFoundException</code> → <code>404</code>.</span>
      </div>
      <div class="status-row">
        <span class="status-code s-4xx">409</span>
        <span class="status-name">Conflict</span>
        <span class="status-desc">O <code>idempotencyKey</code> enviado já está associado a uma transação com status <code>PROCESSING</code>. O <code>GlobalExceptionHandler</code> mapeia <code>IdempotencyConflictException</code> → <code>409</code>.</span>
      </div>
      <div class="status-row">
        <span class="status-code s-4xx">429</span>
        <span class="status-name">Too Many Requests</span>
        <span class="status-desc">Limite de requisições excedido para a <code>x-api-key</code>. Ver <a href="rate-limiting.html">Rate Limiting</a>.</span>
      </div>

      <div class="status-group-header sg-5xx" style="border-top:1px solid var(--border);">5xx — Erro do servidor</div>
      <div class="status-row">
        <span class="status-code s-5xx">500</span>
        <span class="status-name">Server Error</span>
        <span class="status-desc">Exceção não tratada capturada pelo handler genérico <code>handleGenericException(Exception)</code>. Inclua <code>path</code> e <code>timestamp</code> ao reportar problemas via suporte.</span>
      </div>
    </div>

    <h2>Exemplos de Resposta de Erro</h2>

    <div class="codeblock">
      <div class="codeblock-header">
        <div class="lang-tabs">
          <button class="lang-tab active" data-tab="err-400" onclick="switchTab(event)">400 Validação</button>
          <button class="lang-tab" data-tab="err-401" onclick="switchTab(event)">401 Unauthorized</button>
          <button class="lang-tab" data-tab="err-403" onclick="switchTab(event)">403 Forbidden</button>
          <button class="lang-tab" data-tab="err-409" onclick="switchTab(event)">409 Conflict</button>
          <button class="lang-tab" data-tab="err-500" onclick="switchTab(event)">500 Server Error</button>
        </div>
        <button class="copy-btn" onclick="copyBlock(this)">Copiar</button>
      </div>
      <div class="codeblock-body">
<div class="tab-pane active" id="err-400"><span class="t-comment">// MethodArgumentNotValidException — campo obrigatório ausente</span>
<span class="t-comment">// Gerado quando "amount" ou "currency" não são enviados no body</span>
<span class="t-punct">{</span>
  <span class="t-key">"timestamp"</span><span class="t-punct">:</span> <span class="t-num">1740161400000</span><span class="t-punct">,</span>
  <span class="t-key">"status"</span><span class="t-punct">:</span> <span class="t-num">400</span><span class="t-punct">,</span>
  <span class="t-key">"error"</span><span class="t-punct">:</span> <span class="t-str">"Dados inválidos"</span><span class="t-punct">,</span>
  <span class="t-key">"message"</span><span class="t-punct">:</span> <span class="t-str">"amount: não deve ser nulo; currency: não deve ser vazio"</span><span class="t-punct">,</span>
  <span class="t-key">"path"</span><span class="t-punct">:</span> <span class="t-str">"/v1/payments"</span>
<span class="t-punct">}</span></div>
<div class="tab-pane" id="err-401"><span class="t-comment">// ApiKeyAuthFilter — header ausente ou chave não encontrada</span>
<span class="t-comment">// Retornado ANTES de qualquer lógica de negócio</span>
<span class="t-punct">{</span>
  <span class="t-key">"timestamp"</span><span class="t-punct">:</span> <span class="t-num">1740161380000</span><span class="t-punct">,</span>
  <span class="t-key">"status"</span><span class="t-punct">:</span> <span class="t-num">401</span><span class="t-punct">,</span>
  <span class="t-key">"error"</span><span class="t-punct">:</span> <span class="t-str">"Nao autorizado"</span><span class="t-punct">,</span>
  <span class="t-key">"message"</span><span class="t-punct">:</span> <span class="t-str">"API key ausente ou invalida."</span><span class="t-punct">,</span>
  <span class="t-key">"path"</span><span class="t-punct">:</span> <span class="t-str">"/v1/payments"</span>
<span class="t-punct">}</span></div>
<div class="tab-pane" id="err-403"><span class="t-comment">// TenantInactiveException — chave válida mas tenant desativado</span>
<span class="t-comment">// Diferente do 401: a chave existe, mas o acesso foi bloqueado</span>
<span class="t-punct">{</span>
  <span class="t-key">"timestamp"</span><span class="t-punct">:</span> <span class="t-num">1740161450000</span><span class="t-punct">,</span>
  <span class="t-key">"status"</span><span class="t-punct">:</span> <span class="t-num">403</span><span class="t-punct">,</span>
  <span class="t-key">"error"</span><span class="t-punct">:</span> <span class="t-str">"Acesso negado"</span><span class="t-punct">,</span>
  <span class="t-key">"message"</span><span class="t-punct">:</span> <span class="t-str">"Tenant inativo. Entre em contato com o suporte."</span><span class="t-punct">,</span>
  <span class="t-key">"path"</span><span class="t-punct">:</span> <span class="t-str">"/v1/payments"</span>
<span class="t-punct">}</span></div>
<div class="tab-pane" id="err-409"><span class="t-comment">// IdempotencyConflictException — pagamento já em processamento</span>
<span class="t-punct">{</span>
  <span class="t-key">"timestamp"</span><span class="t-punct">:</span> <span class="t-num">1740161400000</span><span class="t-punct">,</span>
  <span class="t-key">"status"</span><span class="t-punct">:</span> <span class="t-num">409</span><span class="t-punct">,</span>
  <span class="t-key">"error"</span><span class="t-punct">:</span> <span class="t-str">"Conflito de Idempotencia"</span><span class="t-punct">,</span>
  <span class="t-key">"message"</span><span class="t-punct">:</span> <span class="t-str">"Pagamento já está em processamento ativo."</span><span class="t-punct">,</span>
  <span class="t-key">"path"</span><span class="t-punct">:</span> <span class="t-str">"/v1/payments"</span>
<span class="t-punct">}</span></div>
<div class="tab-pane" id="err-500"><span class="t-comment">// handleGenericException — exceção não prevista</span>
<span class="t-punct">{</span>
  <span class="t-key">"timestamp"</span><span class="t-punct">:</span> <span class="t-num">1740161500000</span><span class="t-punct">,</span>
  <span class="t-key">"status"</span><span class="t-punct">:</span> <span class="t-num">500</span><span class="t-punct">,</span>
  <span class="t-key">"error"</span><span class="t-punct">:</span> <span class="t-str">"Erro interno do servidor"</span><span class="t-punct">,</span>
  <span class="t-key">"message"</span><span class="t-punct">:</span> <span class="t-str">"Ocorreu um erro inesperado. Tente novamente em instantes."</span><span class="t-punct">,</span>
  <span class="t-key">"path"</span><span class="t-punct">:</span> <span class="t-str">"/v1/payments"</span>
<span class="t-punct">}</span></div>
      </div>
    </div>

    <div class="callout" style="margin-top:1.5rem;">
      <strong>Dica de depuração</strong><br>
      O campo <code>timestamp</code> é um <code>Long</code> Unix em milissegundos (gerado via <code>System.currentTimeMillis()</code>). Use-o para correlacionar a chamada com os logs internos. Ao abrir um suporte, inclua sempre o <code>timestamp</code> e o <code>path</code> exatos da resposta de erro.
    </div>

    <div class="callout callout-tip" style="margin-top:1rem;">
      <strong>401 vs 403 — qual a diferença?</strong><br>
      <code>401</code> significa que a identidade é desconhecida — o header <code>x-api-key</code> está ausente ou a chave não existe no sistema. <code>403</code> significa que a identidade é conhecida, mas o acesso foi negado — a chave existe, mas o tenant foi desativado. Trate os dois de forma diferente: <code>401</code> geralmente indica um bug de configuração; <code>403</code> requer contato com o suporte.
    </div>

  </main>
</div>

<script>
function toggleTheme(){
  const html=document.documentElement;
  const isLight=html.getAttribute('data-theme')==='light';
  const newTheme=isLight?'dark':'light';
  html.setAttribute('data-theme',newTheme);
  localStorage.setItem('theme',newTheme);
  document.getElementById('themeIcon').innerHTML=isLight
    ?'<circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>'
    :'<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
}
function applyTheme(){
  const saved=localStorage.getItem('theme');
  if(saved==='light'){
    document.documentElement.setAttribute('data-theme','light');
    document.getElementById('themeIcon').innerHTML='<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
  }
}
applyTheme();
function switchTab(e){
  const btn=e.target.closest('.lang-tab');
  const cb=btn.closest('.codeblock');
  const tabId=btn.dataset.tab;
  cb.querySelectorAll('.lang-tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  cb.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
  const pane=document.getElementById(tabId);if(pane)pane.classList.add('active');
}
function copyBlock(btn){
  const cb=btn.closest('.codeblock');
  const active=cb.querySelector('.tab-pane.active')||cb.querySelector('.tab-pane');
  navigator.clipboard.writeText(active?active.innerText:'').then(()=>{
    btn.textContent='Copiado';btn.classList.add('copied');
    setTimeout(()=>{btn.textContent='Copiar';btn.classList.remove('copied');},2000);
  });
}
</script>
<script src="shared.js"></script>
</body>
</html>
